---
name: fix
description: 開発環境で小さなバグの修正や軽微な改善を素早く実行
priority: high
suitable_for:
  scale: [small]
  type: [fix, refactor]
  understanding: "≥ 80%"
  urgency: [low, medium]  # Not for emergencies
  environment: development  # Development environment only
aliases: [qf]
timeout: 30
allowed-tools: Bash(git diff:*), Bash(npm test:*), Bash(npm run:*), Edit, MultiEdit, Read, Grep, TodoWrite
context:
  files_changed: "dynamic"
  lines_changed: "tracked"
  test_status: "monitored"
  quality_checks: "parallel"
  confidence_level: "scored"
excludes: [hotfix]  # Don't suggest both
---

# /fix - 動的分析付き高度なクイックフィックス

## 目的

動的問題検出、信頼度スコアリング、並列品質検証で小さなバグを素早く修正します。

## 使用方法

広範な計画や調査を必要としない簡単な修正に使用します。

## 動的問題コンテキスト

### 最近の変更分析
最近の変更を確認:
```bash
git diff HEAD~1 --stat 2>/dev/null | head -5
```

### テストステータスチェック
テストファイル数を確認:
```bash
npm test -- --listTests 2>/dev/null | grep -E "(test|spec)" | wc -l | xargs -I {} echo "利用可能なテストファイル: {}"
```

### 品質コマンド発見
品質スクリプトを確認:
```bash
npm run 2>&1 | grep -E "lint|type|check|test" | head -5
```

### 関連ファイル検出
変更されたファイルを一覧表示:
```bash
git ls-files --modified 2>/dev/null | head -5
```

## 階層的修正プロセス

### フェーズ1: 問題分析 (信頼度目標: 0.85)
動的根本原因特定：
1. **問題検出**: 症状とエラーパターンを分析
2. **影響範囲**: 影響を受けるファイルとコンポーネントを特定
3. **根本原因**: 何ではなくなぜを特定
4. **修正戦略**: 最もシンプルで効果的なアプローチを選択

### フェーズ2: ターゲット実装 (信頼度目標: 0.90)
信頼度スコアリングで修正を適用：
- **高信頼度 (>0.9)**: 直接修正実装
- **中程度 (0.7-0.9)**: 防御的チェックを追加
- **低 (<0.7)**: 修正前に調査

### フェーズ3: 並列検証 (信頼度目標: 0.95)
同時品質チェック：
```typescript
// 逐次ではなく並列で実行
const checks = [
  Bash({ command: "npm test -- --findRelatedTests" }),
  Bash({ command: "npm run lint -- --fix" }),
  Bash({ command: "npm run type-check" })
];
```

## 信頼度メトリクス付き強化実行

### 1. 動的問題分析

#### 問題分類
```markdown
## 問題分析 (信頼度: X.XX)
### カテゴリ: [UI/ロジック/パフォーマンス/型/テスト]
- **症状**: [観察可能な動作]
- **証拠**: [エラーメッセージ、テスト失敗]
- **根本原因**: [なぜ起きているか]
- **信頼度**: [0.0-1.0 スコア]
```

#### 最近のコンテキスト
最近の修正コミットを表示:
```bash
git log --oneline -5 --grep="fix" 2>/dev/null
```

### 2. スマート実装

#### 修正アプローチ選択
```markdown
## 修正戦略 (信頼度: X.XX)
### 選択したアプローチ: [名称]
- **実装**: [修正方法]
- **理由**: [このアプローチの理由]
- **リスクレベル**: [低/中/高]
- **代替案**: [信頼度 < 0.8 の場合]
```

#### プログレッシブエンハンスメントチェック
```markdown
## CSSファースト分析
- CSSで解決可能？ [はい/いいえ]
- はいの場合: [CSSソリューション]
- いいえの場合: [JSが必要な理由]
```

### 3. リアルタイム検証

#### 並列品質実行
テスト、リント、型チェックを実行:
```bash
npm test -- --findRelatedTests 2>&1 | grep -E "PASS|FAIL" | head -5
```
```bash
npm run lint 2>&1 | tail -3
```
```bash
npm run type-check 2>&1 | tail -3
```

#### リグレッションチェック
変更されたテストを実行:
```bash
npm test -- --onlyChanged 2>&1 | grep -E "Test Suites:"
```

## 高度なTodoWrite統合

信頼度スコアリング付きリアルタイム追跡：

```markdown
# 修正: [問題の説明]
## 分析フェーズ (信頼度: X.XX)
1. ✅ 問題特定 [C: 0.95] ✓ 2分
2. ❌ 根本原因分析 [C: 0.85] ⏱️ アクティブ
3. ⏳ 修正戦略選択 [C: 保留]

## 実装フェーズ
4. ⏳ ターゲット修正を適用 [C: 保留]
5. ⏳ 関連テストを更新 [C: 保留]

## 検証フェーズ
6. ⏳ 品質チェック実行（並列） [C: 保留]
7. ⏳ 修正が問題を解決することを確認 [C: 保留]

## メトリクス
- 🎯 問題の明確さ: 85%
- 🔧 修正信頼度: 90%
- ✅ テストパス: 12/12
- 📊 カバレッジ影響: +2%
```

## 信頼度スコアリング付き完了定義

```markdown
## 修正完了チェックリスト
### 問題解決
- ✅ 根本原因特定済み [C: 0.92]
- ✅ 修正が原因に対処（症状ではなく） [C: 0.88]
- ✅ 最小複雑度ソリューション [C: 0.95]

### 品質メトリクス
- ✅ すべての関連テストパス [C: 1.0]
- ✅ 新しいリントエラーなし [C: 0.98]
- ✅ 型安全性維持 [C: 1.0]
- ✅ リグレッション検出なし [C: 0.93]

### コード標準
- ✅ 既存パターンに従う [C: 0.90]
- ✅ プログレッシブエンハンスメント適用 [C: 0.87]
- ✅ 必要に応じてドキュメント更新 [C: 0.85]

### 総合信頼度: 0.91 (高)
ステータス: ✅ 修正完了
```

信頼度 < 0.8 のメトリクスがある場合、改善を続ける。

## 強化された出力フォーマット

```markdown
## 🔧 修正サマリー
### 問題
- **問題**: [説明]
- **カテゴリ**: [UI/ロジック/パフォーマンス/型]
- **根本原因**: [なぜ起きたか]
- **信頼度**: 0.XX

### 適用したソリューション
- **アプローチ**: [使用した修正戦略]
- **変更ファイル**: 
  - `path/to/file.ts` - [何が変更されたか]
  - `path/to/test.ts` - [テスト更新]
- **プログレッシブエンハンスメント**: [CSSファーストアプローチ使用？]

### 検証結果
- **テスト**: ✅ 15/15 パス
- **リント**: ✅ 問題なし
- **型**: ✅ すべて有効
- **カバレッジ**: 82% (+2%)
- **リグレッション**: 検出なし

### 信頼度メトリクス
| ステージ | 信頼度 | 結果 |
|----------|---------|------|
| 分析 | 0.88 | 根本原因発見 |
| 実装 | 0.92 | クリーンな修正適用 |
| 検証 | 0.95 | 全チェックパス |
| **総合** | **0.91** | **高信頼度** |

### パフォーマンス影響
```bash
git diff HEAD --stat | tail -3
```
- 変更行数: XX
- 影響ファイル: X
- 複雑度: 低
```

## 決定フレームワーク

### `/fix` を使用する場合（信頼度チェック）
```markdown
✅ 高信頼度シナリオ (>0.85)
- 明確なスコープの単一ファイル修正
- 明らかな原因のテスト失敗
- タイポと命名の修正
- CSSで解決可能なUI問題
- シンプルなロジックエラー
- 設定更新

⚠️ 中信頼度 (0.6-0.85)
- 2ファイルの協調変更
- 欠落しているエラーハンドリング
- パフォーマンス最適化
- 状態管理の修正

❌ 低信頼度 (<0.6) - 別コマンド使用
- 複数ファイルリファクタリング → /code
- 不明な根本原因 → /research
- 新機能 → /think → /code
- 本番環境の問題 → /hotfix
```

### 自動コマンド切り替え
分析中に信頼度が0.6を下回った場合：
```markdown
## 低信頼度検出
### 問題: 修正スコープが/fixの能力を超えています

推奨アクション:
- 調査用: /research
- 計画用: /think
- 実装用: /code

コマンドを切り替えますか？ (Y/n)
```

## 信頼度付き使用例

### 高信頼度修正
```md
/fix "ヘッダーのボタン配置の問題を修正"
# 信頼度: 0.92 - CSSファーストソリューション利用可能
```

### 中信頼度修正
```md
/fix "状態更新が再レンダリングをトリガーしない問題を解決"
# 信頼度: 0.75 - 調査が必要かもしれません
```

### 自動エスカレーション例
```md
/fix "データベースクエリパフォーマンスを最適化"
# 信頼度: 0.45 - /research → /think を提案
```

## 結果に基づく次のステップ

### 成功パス (信頼度 >0.9)
- 学びを文書化
- リグレッションテストを追加
- 関連ドキュメントを更新

### 部分的成功 (信頼度 0.7-0.9)
- 完全性のため `/research` でレビュー
- 残りの問題にフォローアップ `/fix` を検討

### エスカレーションパス (信頼度 <0.7)
```markdown
## 推奨ワークフロー
分析に基づいて提案：
1. /research - より深く調査
2. /think - 包括的解決策を計画
3. /code - 完全なTDDで実装
```

## 高度な機能

### パターン学習
類似問題の成功した修正を追跡：
```bash
git log --grep="fix" --oneline | head -3
```

### 自動発見
修正が必要な関連問題を見つける：
```bash
grep -r "TODO\|FIXME\|HACK" --include="*.ts" --include="*.tsx" | head -5
```

### 品質トレンド
コードベースの健全性への修正影響を監視：
```bash
npm run lint 2>&1 | grep -E "problems\|warnings"
```

## 適用される原則

このコマンドは [@~/.claude/rules/development/PROGRESSIVE_ENHANCEMENT.md] からのProgressive Enhancementを適用します：

- UI問題に対するCSSファーストアプローチ
- 根本原因分析
- 最小限の複雑さのソリューション

## コマンド識別ガイド

### `/fix` を使用する場合

- 🔧 開発環境で作業中
- 問題が小さく、よく理解されている
- 修正は通常通りテストできる
- 本番環境の緊急事態ではない
- 標準的なデプロイタイムラインが許容可能

### 代わりに `/hotfix` を使用する場合

- 🚨 本番環境がダウンまたは障害がある
- 本番環境のセキュリティ脆弱性
- ユーザーが積極的に影響を受けている
- 即座のデプロイが必要
- 緊急対応が必要

### 主な違い

- **fix**: 通常のテスト/デプロイを伴う迅速な開発修正
- **hotfix**: 即座のアクションが必要な緊急本番修正
