# タスク前理解度確認

理解度確認と実行計画のための技術仕様。

## 実行ルール

**主要条件**: PRE_TASK_CHECKは以下を含むタスクで実行：

- ファイル操作（作成/編集/削除）
- コマンド実行（bash、npmなど）
- 複数ステップのワークフロー
- 曖昧または複雑なリクエスト
- 理解度が95%未満の場合

**スキップ条件**（AI判断可）：

- 単純な事実質問（「Xとは何？」）
- 確認応答（「y」、「yes」、「ok」）
- 既存コンテンツに関する直接的な情報クエリ
- アクションを必要としないフォローアップの明確化
- 説明やドキュメントのリクエスト

**常に必要**：

- ファイルシステムの変更
- コード実装リクエスト
- システムコマンド実行
- /コマンドを必要とするタスク
- ユーザーが明示的に計画を要求した場合

## 分析方法

ユーザーリクエストを分析して以下を決定：

- 利用可能な情報に基づく理解度パーセンテージ
- 明確な要素と不明確な要素
- 適切なコマンドまたはアプローチ
- 実行可能性

## 表示フォーマット

理解度確認の標準フォーマット（必要な場合）：

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🧠 理解レベル: [プログレスバー] XX%

✅ 明確に理解できた要素:
- [完全な情報がある項目]

❓ 不明確または推定した要素:
- [曖昧な部分]

📋 確認したい追加情報:
- [必要な仕様]

💡 提案するアプローチ:
- Command: [/command または N/A]
- 理由: [簡潔な説明]

⚡ 実現可能性: 🟢 すぐに実行可能 / 🟡 追加情報が必要 / 🔴 大きなギャップ

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

この理解で正しいですか？実行計画が必要な場合は表示されます。(Y/n/i)
```

**[ここで停止 - ユーザー応答を待つ]**

注: 出力ラベルはCLAUDE.md P1ルールに従って日本語に変換

プログレスバー: █ = 10%（左から右に埋める、空は░を使用）

## コマンド提案システム

**コマンドを提案する場合**: 理解度 ≥ 70%、技術的タスク
**注**: これはコマンド提案のみで、理解度確認表示ではない
**ソース**: ~/.claude/commands/、.claude/commands/

### 動的発見

1. *.mdファイルのディレクトリをスキャン
2. YAMLメタデータを抽出（存在する場合）
3. タスク特性を分析
4. コマンドをスコアリングとランク付け

### タスク分析

実際のタスクの意図と要件の理解に基づく。
詳細: [@../commands/COMMAND_SELECTION.md]を参照

### 出力フォーマット

**重要**: CommandフィールドにはスラッシュコマンドまたはN/Aのみを含める。説明や他のテキストは入れない。

**単一コマンド**:

```markdown
💡 提案するアプローチ:
- Command: /fix
- 理由: 小規模修正に最適、理解度90%
```

**ワークフロー**（複数アクション検出）:

```markdown
💡 提案するワークフロー:
- ステップ: /think → /code → /test
- 理由: 計画が必要な複雑なタスク
- TodoWrite: 自動的に3つのタスクを作成
```

**コマンドなし**:

```markdown
💡 提案するアプローチ:
- Command: N/A
- 理由: このタスクに特定のコマンドは不要
```

## 標準ワークフロー

- **バグ修正**: 調査+修正 → `/research → /fix`
- **機能**: 実装+テスト → `/think → /research → /code → /test`
- **緊急対応**: 重大+本番 → `/hotfix`

詳細: [@../commands/STANDARD_WORKFLOWS.md]

## ユーザー応答処理

**重要: 理解度確認後は必ずユーザー応答を待つ**

- Y: 実装に進む（必要に応じて実行計画を表示）
- n: タスク理解を再評価
- i: 追加情報を待つ

## 実行計画（Y確認後）

ファイルを変更またはコマンドを実行する操作に対して表示。
純粋な読み取り操作（Read、Grep、LS）はスキップ。

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 実行計画

以下を実行します：
1. [具体的なアクション]
2. [具体的なアクション]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

この計画で進めてよろしいですか？(Y/n/i)
```

**[ここで停止 - ユーザー応答を待つ]**

**例**:

- ファイル作成: 「新規ファイル /path/to/file.js を作成」
- ファイル編集: 「/path/to/file.js を編集 - エラー処理を追加」
- コマンド実行: 「npm test を実行して変更を検証」

**重要: 実行前にユーザー確認を待つ。**

## エッジケース

- マッチなし（スコア <30）: 「Command: N/A」
- 複雑なタスク: ワークフローを提案
- 新しいコマンド: コマンドディレクトリにあれば自動発見

## 統合ワークフロー

1. **理解度確認**: 理解度を評価しアプローチを提案
2. **ユーザー確認**: Y/n/iを待つ ← **停止ポイント**
3. **実行計画**（Yでファイル/コマンド操作の場合）: 具体的なアクションを表示
4. **計画確認**: 最終的なY/n/iを待つ ← **停止ポイント**
5. **実行**: 承認されたアクションを実行
